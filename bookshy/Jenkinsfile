pipeline {
    agent any

    environment {
        IMAGE_NAME = "frontend"
        DOCKER_IMAGE = "subihwang/frontend"
        DOCKER_TAG = "latest"

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë ¨ ë³€ìˆ˜
        APP_NAME = "book-shy-frontend" // ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ ì„¤ì •

        BLUE_PORT = "3000"
        GREEN_PORT = "3001"

        // ì›ê²© ì„œë²„ ì •ë³´
        REMOTE_USER = credentials('remote-server-credentials')  // ì›ê²© ì„œë²„ ì ‘ì†ìš© ì‚¬ìš©ì ì´ë¦„/ë¹„ë°€ë²ˆí˜¸
        DEV_SERVER = "k12d204.p.ssafy.io"

        // í™˜ê²½ ë³€ìˆ˜
        VITE_BASE_URL = credentials('VITE_BASE_URL')
    }

    stages {
        // gitLab ì €ì¥ì†Œì—ì„œ front ë¸Œëœì¹˜ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜¨ í›„ gitlab ìê²© ì¦ëª…ì„ í™œìš©í•´ ì½”ë“œë¥¼ checkout
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'front']],  // front ë¸Œëœì¹˜ë¡œ ë³€ê²½
                    userRemoteConfigs: [[
                        url: 'https://lab.ssafy.com/s12-final/S12P31D204.git',
                        credentialsId: 'lab-token'
                    ]]
                ])
                sh 'echo "âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"'
            }
        }

        stage('Build') {
            steps {
                script {
                    try {
                        echo 'âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘'
                        dir("${env.WORKSPACE}/book-shy-frontend") {  // í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ë³€ê²½
                            sh '''
                                # ì—ëŸ¬ë‚˜ë©´ ë°”ë¡œ ì •ì§€ì‹œí‚´
                                set -e

                                # Node.js í™˜ê²½ ì„¤ì •
                                export NVM_DIR="$HOME/.nvm"
                                [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                                nvm use 22 || nvm install 22  # Node.js 22 ì‚¬ìš©

                                # npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ (--legacy-peer-deps ì˜µì…˜ ì¶”ê°€)
                                npm install --legacy-peer-deps

                                # TypeScript íƒ€ì… ì²´í¬ ì‹¤í–‰
                                echo "âœ… TypeScript íƒ€ì… ì²´í¬ ì‹¤í–‰ ì¤‘..."
                                npm run type-check || (echo "âŒ íƒ€ì… ì²´í¬ ì‹¤íŒ¨" && exit 1)
                                
                                # ë¦°íŠ¸ ê²€ì‚¬ ì‹¤í–‰
                                echo "âœ… ESLint ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."
                                npm run lint || (echo "âŒ ë¦°íŠ¸ ê²€ì‚¬ ì‹¤íŒ¨" && exit 1)

                                # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                                echo "VITE_BASE_URL=${VITE_BASE_URL}" > .env

                                # ë¹Œë“œ ìˆ˜í–‰
                                npm run build

                                # ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
                                echo "âœ… ë¹Œë“œëœ íŒŒì¼ ëª©ë¡:"
                                ls -l build/
                            '''
                        }
                        echo 'âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì„±ê³µ'
                    } catch (Exception e) {
                        echo 'âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨'
                        error "Build failed: ${e.message}"
                    }
                }
            }
        }

        // Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ê·¸ ì˜ì¡´ì„±ì„ í¬í•¨í•œ ì´ë¯¸ì§€ ìƒì„±
        stage('Build Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', passwordVariable: 'DOCKER_HUB_PSW', usernameVariable: 'DOCKER_HUB_USR')]) {
                    dir("${env.WORKSPACE}/book-shy-frontend") {
                        sh """
                        set -e
                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
                        docker build -t ${DOCKER_HUB_USR}/${IMAGE_NAME}:latest .
                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
                        """
                    }
                }
            }
        }

        // ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ Docker Hubì— ì—…ë¡œë“œí•˜ëŠ” ë‹¨ê³„
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', passwordVariable: 'DOCKER_HUB_PSW', usernameVariable: 'DOCKER_HUB_USR')]) {
                    sh 'echo $DOCKER_HUB_PSW | docker login -u $DOCKER_HUB_USR --password-stdin'
                    sh 'docker push ${DOCKER_HUB_USR}/${IMAGE_NAME}:latest'
                }
            }
        }

        stage('Deploy'){
            steps{
                script{
                    try{
                        // ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ë°©ì‹ìœ¼ë¡œ ê°œë°œ í™˜ê²½ì— ë°°í¬
                        sshagent(credentials: ['remote-server-credentials']) {
                            dir("${env.WORKSPACE}/book-shy-frontend") {
                                // ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ì„ ì›ê²© ì„œë²„ì— ë³µì‚¬
                                sh '''
                                    # ë¶ˆí•„ìš”í•œ ì¶œë ¥ ì™„ì „ ì°¨ë‹¨!
                                    ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} "
                                    mkdir -p /home/ubuntu/frontend
                                    "

                                    scp -v -o StrictHostKeyChecking=no docker-compose.yml ubuntu@${DEV_SERVER}:/home/ubuntu/frontend/
                                    echo "âœ… docker-compose.yml ë³µì‚¬ ì™„ë£Œ"
                                '''

                                // ì›ê²© ì„œë²„ì—ì„œ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ìˆ˜í–‰ - ê° ëª…ë ¹ì„ ë³„ë„ë¡œ ì‹¤í–‰
                                sh '''
                                    # 1ë‹¨ê³„: ì´ˆê¸° ë³€ìˆ˜ ì„¤ì • ë° ë°°í¬ ì»¨í…Œì´ë„ˆ ê²°ì •
                                    ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} '
                                        cd /home/ubuntu/frontend

                                        # ë³€ìˆ˜ ì´ˆê¸°í™”
                                        DOCKER_IMAGE="subihwang/frontend"
                                        DOCKER_TAG="latest"
                                        APP_NAME="book-shy-frontend"
                                        BLUE_PORT="3000"
                                        GREEN_PORT="3001"

                                        # í˜„ì¬ ì–´ë–¤ ë°°í¬ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                                        if [ -f .active_frontend ]; then
                                            ACTIVE_COLOR=$(cat .active_frontend)
                                            if [ "$ACTIVE_COLOR" = "blue" ]; then
                                                echo "âœ… Green deployment ì‹¤í–‰ ì¤‘"
                                                CONTAINER_NAME="${APP_NAME}-green"
                                                CONTAINER_PORT="${GREEN_PORT}"
                                                INACTIVE_CONTAINER="${APP_NAME}-blue"
                                            else
                                                echo "âœ… Blue deployment ì‹¤í–‰ ì¤‘"
                                                CONTAINER_NAME="${APP_NAME}-blue"
                                                CONTAINER_PORT="${BLUE_PORT}"
                                                INACTIVE_CONTAINER="${APP_NAME}-green"
                                            fi
                                        else
                                            echo "âœ… Initial Blue deployment ì‹¤í–‰ ì¤‘"
                                            CONTAINER_NAME="${APP_NAME}-blue"
                                            CONTAINER_PORT="${BLUE_PORT}"
                                            INACTIVE_CONTAINER="${APP_NAME}-green"
                                        fi

                                        # ë³€ìˆ˜ í™•ì¸
                                        echo "CONTAINER_NAME: $CONTAINER_NAME"
                                        echo "CONTAINER_PORT: $CONTAINER_PORT"
                                        echo "INACTIVE_CONTAINER: $INACTIVE_CONTAINER"
                                        echo "DOCKER_IMAGE: ${DOCKER_IMAGE}"
                                        echo "DOCKER_TAG: ${DOCKER_TAG}"

                                        # ìƒˆ ë²„ì „ê³¼ í¬íŠ¸ë¡œ docker-compose ì—…ë°ì´íŠ¸
                                        sed -i "s|{{IMAGE}}|${DOCKER_IMAGE}:${DOCKER_TAG}|g" docker-compose.yml
                                        sed -i "s|{{CONTAINER_NAME}}|$CONTAINER_NAME|g" docker-compose.yml
                                        sed -i "s|{{PORT}}|$CONTAINER_PORT|g" docker-compose.yml

                                        echo "ğŸ“ ì¹˜í™˜ í›„ compose ë‚´ìš©:"
                                        cat docker-compose.yml

                                        # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
                                        docker-compose pull

                                        # ìƒˆ ë²„ì „ ì‹œì‘
                                        docker-compose up -d
                                    '
                                '''

                                // 2ë‹¨ê³„: ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ ë° NGINX ì„¤ì • ì—…ë°ì´íŠ¸
                                sh '''
                                    ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} '
                                        cd /home/ubuntu/frontend

                                        # ë³€ìˆ˜ ë‹¤ì‹œ ì„¤ì •
                                        DOCKER_IMAGE="subihwang/frontend"
                                        DOCKER_TAG="latest"
                                        APP_NAME="book-shy-frontend"
                                        BLUE_PORT="3000"
                                        GREEN_PORT="3001"

                                        # í˜„ì¬ ì–´ë–¤ ë°°í¬ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                                        if [ -f .active_frontend ]; then
                                            ACTIVE_COLOR=$(cat .active_frontend)
                                            if [ "$ACTIVE_COLOR" = "blue" ]; then
                                                CONTAINER_NAME="${APP_NAME}-green"
                                                CONTAINER_PORT="${GREEN_PORT}"
                                            else
                                                CONTAINER_NAME="${APP_NAME}-blue"
                                                CONTAINER_PORT="${BLUE_PORT}"
                                            fi
                                        else
                                            CONTAINER_NAME="${APP_NAME}-blue"
                                            CONTAINER_PORT="${BLUE_PORT}"
                                        fi

                                        # ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                                        echo "âœ… ì»¨í…Œì´ë„ˆ ì •ìƒ ìƒíƒœ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘"
                                        for i in {1..15}; do
                                            if curl -s http://localhost:$CONTAINER_PORT | grep -q "body"; then
                                                echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì•± ì •ìƒ êµ¬ë™ë¨"
                                                break
                                            fi
                                            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ $i"
                                            sleep 2
                                        done

                                        # ì–´ë–¤ ë°°í¬ê°€ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ ê¸°ë¡
                                        if [ "$CONTAINER_NAME" = "${APP_NAME}-blue" ]; then
                                            echo "blue" > .active_frontend
                                        else
                                            echo "green" > .active_frontend
                                        fi
                                    '
                                '''
                                // 3ë‹¨ê³„: NGINX ì„¤ì • ì—…ë°ì´íŠ¸
                                sh '''
                                    ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} '
                                        cd /home/ubuntu/frontend

                                        # í˜„ì¬ í™œì„±í™”ëœ ìƒ‰ìƒ í™•ì¸
                                        ACTIVE_COLOR=$(cat .active_frontend)

                                        # Nginx ì„¤ì •ì— í™œì„± ë°°í¬ ì •ë³´ ê¸°ë¡
                                        echo "upstream frontend_servers {" > /tmp/nginx_frontend_upstream.conf
                                        if [ "$ACTIVE_COLOR" = "blue" ]; then
                                            echo "    server 127.0.0.1:3000;" >> /tmp/nginx_frontend_upstream.conf
                                        else
                                            echo "    server 127.0.0.1:3001;" >> /tmp/nginx_frontend_upstream.conf
                                        fi
                                        echo "}" >> /tmp/nginx_frontend_upstream.conf
                                        
                                        # í”„ë¡ íŠ¸ì—”ë“œ location ì„¤ì • ì¶”ê°€
                                        echo "server {" >> /tmp/nginx_frontend_upstream.conf
                                        echo "    listen 80;" >> /tmp/nginx_frontend_upstream.conf
                                        echo "    server_name k12d204.p.ssafy.io;" >> /tmp/nginx_frontend_upstream.conf
                                        echo "    location / {" >> /tmp/nginx_frontend_upstream.conf
                                        echo "        proxy_pass http://frontend_servers;" >> /tmp/nginx_frontend_upstream.conf
                                        echo "        proxy_http_version 1.1;" >> /tmp/nginx_frontend_upstream.conf
                                        echo "        proxy_set_header Upgrade \$http_upgrade;" >> /tmp/nginx_frontend_upstream.conf
                                        echo "        proxy_set_header Connection 'upgrade';" >> /tmp/nginx_frontend_upstream.conf
                                        echo "        proxy_set_header Host \$host;" >> /tmp/nginx_frontend_upstream.conf
                                        echo "        proxy_cache_bypass \$http_upgrade;" >> /tmp/nginx_frontend_upstream.conf
                                        echo "    }" >> /tmp/nginx_frontend_upstream.conf
                                        echo "}" >> /tmp/nginx_frontend_upstream.conf
                                        
                                        # NGINX ì„¤ì • ë””ë ‰í† ë¦¬ë¡œ ì´ë™
                                        sudo mv /tmp/nginx_frontend_upstream.conf /home/ubuntu/nginx/conf.d/frontend_upstream.conf

                                        # NGINX ì„¤ì • ë¦¬ë¡œë“œ
                                        docker exec ubuntu-nginx-1 nginx -s reload || echo "âŒï¸ NGINX ë¦¬ë¡œë“œ ì‹¤íŒ¨"
                                        echo "âœ… NGINX ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ"

                                        # ë¹„í™œì„± ì»¨í…Œì´ë„ˆ ì •ì§€
                                        if [ "$ACTIVE_COLOR" = "blue" ]; then
                                            INACTIVE_CONTAINER="${APP_NAME}-green"
                                        else
                                            INACTIVE_CONTAINER="${APP_NAME}-blue"
                                        fi

                                        # ì—°ê²°ì´ ë“œë ˆì¸ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° í›„ ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
                                        sleep 10
                                        docker stop "${INACTIVE_CONTAINER}" || true
                                        docker rm "${INACTIVE_CONTAINER}" || true
                                    '
                                '''
                            }
                        }
                    } catch (Exception e) {
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨
                        error "âŒ ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        // ì„±ê³µì ì¸ ë°°í¬ í›„ ì´ì „ ë²„ì „ì„ ì •ë¦¬í•˜ëŠ” ë‹¨ê³„
        stage('Cleanup Old Deployment'){
            steps {
                // ì´ì „ ì»¨í…Œì´ë„ˆ ë° ì´ë¯¸ì§€ ì •ë¦¬
                sshagent(credentials: ['remote-server-credentials']) {
                    sh '''
                        # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì»¨í…Œì´ë„ˆ ì •ë¦¬
                        ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} 'docker container prune -f'

                        # íƒœê·¸ê°€ ì—†ëŠ” ì´ë¯¸ì§€ ì •ë¦¬
                        ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} 'docker image prune -f'

                        echo "âœ… ì´ì „ ë°°í¬ ì •ë¦¬ ì™„ë£Œ"
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                try {
                    // ì‘ì—… ê³µê°„ ì •ë¦¬
                    cleanWs()
                } catch (Exception e) {
                    echo "ì‘ì—… ê³µê°„ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}"
                }
            }
        }
        success {
            echo 'âœ… íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µ!'
        }
        failure{
            // ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
            echo 'âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨'
            emailext (
                subject: "ì‹¤íŒ¨: íŒŒì´í”„ë¼ì¸ '${currentBuild.fullDisplayName}'",
                body: "íŒŒì´í”„ë¼ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹Œë“œ URL: ${env.BUILD_URL}",
                to: 'ghkdtnql@gmail.com'
            )
        }
    }
}