pipeline {
    agent any

    environment {
        IMAGE_NAME = "backend"
        DOCKER_IMAGE = "subihwang/backend"
        DOCKER_TAG = "latest"

        // SonarQube ê´€ë ¨ ì„¤ì •
        SONAR_HOST_URL = "http://sonarqube:9000/sonarqube"
        SONAR_PROJECT_KEY = "book-shy"
        SONAR_TOKEN = credentials('sonarqube-token')  // Jenkins Credentialsì— ë“±ë¡ëœ í† í°

        // ì›ê²© ì„œë²„ ì •ë³´
        REMOTE_USER = credentials('remote-server-credentials')  // ì›ê²© ì„œë²„ ì ‘ì†ìš© ì‚¬ìš©ì ì´ë¦„/ë¹„ë°€ë²ˆí˜¸
        DEV_SERVER = "k12d204.p.ssafy.io"

        // DB ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜
        DB_URL = credentials('DB_URL')
        DB_USERNAME = credentials('DB_USERNAME')
        DB_PASSWORD = credentials('DB_PASSWORD')

        // Redis í™˜ê²½ ë³€ìˆ˜
        REDIS_PASSWORD = credentials('REDIS_PASSWORD')

        // Kafka
        KAFKA_BOOTSTRAP_SERVERS = credentials('KAFKA_BOOTSTRAP_SERVERS')
        ELK_URL = credentials('ELK_URL')

        JWT_KEY = credentials('JWT_KEY')
        ALADIN_TTB_KEY = credentials('ALADIN_TTB_KEY')
        ALADIN_BASE_URL = credentials('ALADIN_BASE_URL')
        NAVER_OCR_SECRET_KEY = credentials('NAVER_OCR_SECRET_KEY')
        NAVER_OCR_URL = credentials('NAVER_OCR_URL')

        KAKAO_USER_INFO_URI = credentials('KAKAO_USER_INFO_URI')
        KAKAO_CLIENT_ID = credentials('KAKAO_CLIENT_ID')        // ì¶”ê°€
        KAKAO_REDIRECT_URI = credentials('KAKAO_REDIRECT_URI')  // ì¶”ê°€

        FIREBASE_PROJECT_ID = 'bookshy-b4c32'
        GOOGLE_APPLICATION_CREDENTIALS = '/app/secret/firebase-service-account.json'
    }

    stages {
        //gitLab ì €ì¥ì†Œì—ì„œ back ë¸Œëœì¹˜ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜¨ í›„ gitlab ìê²© ì¦ëª…ì„ í™œìš©í•´ ì½”ë“œë¥¼ checkout
        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'back']],
                    userRemoteConfigs: [[
                        url: 'https://lab.ssafy.com/s12-final/S12P31D204.git',
                        credentialsId: 'lab-token'
                    ]]
                ])
                sh 'echo "âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"'
            }
        }

        stage('Build') {
            steps {
                script {
                    try {
                        echo 'âœ… ë°±ì—”ë“œ ë¹Œë“œ ì‹œì‘'
                        dir("${env.WORKSPACE}/book-shy") {
                            sh '''
                                # ì—ëŸ¬ë‚˜ë©´ ë°”ë¡œ ì •ì§€ì‹œí‚´
                                set -e

                                # ì¸ì½”ë”© ì„¤ì •
                                export JAVA_TOOL_OPTIONS="-Dfile.encoding=UTF-8"

                                # gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                                chmod +x gradlew

                                # ê¸°ì¡´ ë¹Œë“œ ë””ë ‰í† ë¦¬ ì‚­ì œ
                                rm -rf build

                                # ë¹Œë“œ ìˆ˜í–‰ (í…ŒìŠ¤íŠ¸ ì œì™¸)
                                ./gradlew clean build -x test

                                # ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
                                echo "âœ… ë¹Œë“œëœ íŒŒì¼ ëª©ë¡:"
                                ls -l build/libs/
                            '''
                        }
                        echo 'âœ… ë°±ì—”ë“œ ë¹Œë“œ ì„±ê³µ'
                    } catch (Exception e) {
                        echo 'âŒ ë°±ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨'
                        error "Build failed: ${e.message}"
                    }
                }
            }
        }

        stage('Code Analysis'){
            steps{
                script{
                    try{
                        echo 'âœ… ì½”ë“œ ë¶„ì„ ì‹œì‘'

                        // í˜„ì¬ ë””ë ‰í† ë¦¬ í™•ì¸
                        sh 'echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"'
                        sh 'echo "ë””ë ‰í† ë¦¬ ë‚´ìš©: $(ls -la)"'

                        // SonarQube í™˜ê²½ ë³€ìˆ˜ í™•ì¸
                        sh 'echo "SonarQube URL: ${SONAR_HOST_URL}"'
                        sh 'echo "SonarQube Project Key: ${SONAR_PROJECT_KEY}"'
                        sh 'echo "Book-shy ë””ë ‰í† ë¦¬ í™•ì¸: $(ls -la book-shy)"'

                        //SonarQube ìŠ¤ìºë„ˆ ì„¤ì •ìœ¼ë¡œ ì½”ë“œ ë¶„ì„ ì‹¤í–‰
                        withSonarQubeEnv('SonarQube'){
                            echo "âœ… SonarQube í™˜ê²½ ì„¤ì • ì„±ê³µ"

                            dir("${env.WORKSPACE}/book-shy"){
                                // ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
                                sh 'echo "book-shy ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì„±ê³µ"'
                                sh 'echo "í˜„ì¬ ìœ„ì¹˜: $(pwd)"'
                                sh 'echo "ë””ë ‰í† ë¦¬ ë‚´ìš©: $(ls -la)"'

                                // Gradle ì„¤ì • í™•ì¸
                                sh 'echo "Gradle ì„¤ì • íŒŒì¼ í™•ì¸:"'
                                sh 'cat build.gradle || echo "build.gradle not found"'

                                // Gradle ê¶Œí•œ í™•ì¸ ë° ë¶€ì—¬
                                sh 'echo "Gradle ê¶Œí•œ í™•ì¸:"'
                                sh 'ls -la gradlew || echo "gradlew not found"'
                                sh 'chmod +x gradlew || echo "âŒ ê¶Œí•œ ë¶€ì—¬ ì‹¤íŒ¨"'

                                // ìƒì„¸ ë¡œê·¸ì™€ í•¨ê»˜ SonarQube ë¶„ì„ ì‹¤í–‰ ì‹œë„
                                sh 'echo "âœ… SonarQube ë¶„ì„ ì‹œì‘"'
                                sh '''
                                    ./gradlew sonarqube \
                                        -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                        -Dsonar.projectName=backend \
                                        -Dsonar.host.url=${SONAR_HOST_URL} \
                                        -Dsonar.login=${SONAR_TOKEN} \
                                        --stacktrace --info || echo "âŒ Gradle SonarQube ì‹¤í–‰ ì‹¤íŒ¨"
                                '''
                            }
                        }
                        echo 'âœ… ì½”ë“œ ë¶„ì„ ì™„ë£Œ'
                    } catch(Exception e){
                        echo 'âŒ ì½”ë“œ ë¶„ì„ ì‹¤íŒ¨'
                        error "Code analysis failed: ${e.message}"
                    }
                }
            }
        }

        //Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ê·¸ ì˜ì¡´ì„±ì„ í¬í•¨í•œ ì´ë¯¸ì§€ ìƒì„±
        stage('Build Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', passwordVariable: 'DOCKER_HUB_PSW', usernameVariable: 'DOCKER_HUB_USR')]) {
                    dir("${env.WORKSPACE}/book-shy") {
                        sh """
                        set -e
                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
                        docker build -t ${DOCKER_HUB_USR}/${IMAGE_NAME}:latest .
                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
                        """
                    }
                }
            }
        }

        //ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ Docker Hubì— ì—…ë¡œë“œí•˜ëŠ” ë‹¨ê³„
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', passwordVariable: 'DOCKER_HUB_PSW', usernameVariable: 'DOCKER_HUB_USR')]) {
                    sh 'echo $DOCKER_HUB_PSW | docker login -u $DOCKER_HUB_USR --password-stdin'
                    sh 'docker push ${DOCKER_HUB_USR}/${IMAGE_NAME}:latest'
                }
            }
        }

        stage('Deploy'){
            steps{
                script{
                    try{
                        // ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ë°©ì‹ìœ¼ë¡œ ê°œë°œ í™˜ê²½ì— ë°°í¬
                        sshagent(credentials: ['remote-server-credentials']) {
                            dir("${env.WORKSPACE}/book-shy") {
                                // ğŸ”¹ firebase-service-account.json íŒŒì¼ ì¤€ë¹„
                                withCredentials([file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_CREDENTIAL_FILE')]) {
                                    sh '''
                                        mkdir -p secrets
                                        cp $FIREBASE_CREDENTIAL_FILE secrets/firebase-service-account.json
                                        echo "âœ… firebase-service-account.json ë¡œì»¬ ë³µì‚¬ ì™„ë£Œ"
                                    '''
                                }

                                // ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ì„ ì›ê²© ì„œë²„ì— ë³µì‚¬
                                sh '''
                                    # âœ… 1. docker-compose.yml ì•ˆì— DB_URL, DB_USERNAME, DB_PASSWORD ì§ì ‘ ì¹˜í™˜
                                    sed -i "s|\\${DB_URL}|${DB_URL}|g" docker-compose.yml
                                    sed -i "s|\\${DB_USERNAME}|${DB_USERNAME}|g" docker-compose.yml
                                    sed -i "s|\\${DB_PASSWORD}|${DB_PASSWORD}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml DB ì •ë³´ ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${REDIS_PASSWORD}|${REDIS_PASSWORD}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml Redis ì •ë³´ ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${KAFKA_BOOTSTRAP_SERVERS}|${KAFKA_BOOTSTRAP_SERVERS}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml Kafka ì •ë³´ ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${ELK_URL}|${ELK_URL}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml Kafka ì •ë³´ ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${JWT_KEY}|${JWT_KEY}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml JWT í‚¤ ì •ë³´ ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${ALADIN_TTB_KEY}|${ALADIN_TTB_KEY}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml Aladin Key ê°’ ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${ALADIN_BASE_URL}|${ALADIN_BASE_URL}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml Aladin base-url ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${NAVER_OCR_SECRET_KEY}|${NAVER_OCR_SECRET_KEY}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml OCR Secret Key ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${NAVER_OCR_URL}|${NAVER_OCR_URL}|g" docker-compose.yml
                                    echo "âœ… docker-compose.yml OCR URL ì¹˜í™˜ ì™„ë£Œ"

                                    sed -i "s|\\${KAKAO_USER_INFO_URI}|${KAKAO_USER_INFO_URI}|g" docker-compose.yml
                                    sed -i "s|\\${KAKAO_CLIENT_ID}|${KAKAO_CLIENT_ID}|g" docker-compose.yml
                                    sed -i "s|\\${KAKAO_REDIRECT_URI}|${KAKAO_REDIRECT_URI}|g" docker-compose.yml

                                    echo "âœ… docker-compose.yml Kakao ì •ë³´ ì¹˜í™˜ ì™„ë£Œ"

                                    # âœ… 2. ì„œë²„ì— ì „ì†¡
                                    ssh -o LogLevel=ERROR -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} "
                                        mkdir -p /home/ubuntu
                                        mkdir -p /home/ubuntu/secrets
                                    "

                                    scp -v -o StrictHostKeyChecking=no docker-compose.yml ubuntu@${DEV_SERVER}:/home/ubuntu/
                                    echo "âœ… docker-compose.yml ë³µì‚¬ ì™„ë£Œ"

                                    # âœ… 3. ë°°í¬ ì‹¤í–‰
                                    ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} "
                                        cd /home/ubuntu
                                        docker-compose up -d
                                        echo 'âœ… ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ'
                                    "
                                    '''
                            }
                        }
                    } catch (Exception e) {
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨
                        error "âŒ ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        //ì„±ê³µì ì¸ ë°°í¬ í›„ ì´ì „ ë²„ì „ì„ ì •ë¦¬í•˜ëŠ” ë‹¨ê³„
        stage('Cleanup Old Deployment'){
            steps {
                // ì´ì „ ì»¨í…Œì´ë„ˆ ë° ì´ë¯¸ì§€ ì •ë¦¬
                sshagent(credentials: ['remote-server-credentials']) {
                    sh '''
                        # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì»¨í…Œì´ë„ˆ ì •ë¦¬
                        ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} 'docker container prune -f'

                        # íƒœê·¸ê°€ ì—†ëŠ” ì´ë¯¸ì§€ ì •ë¦¬
                        ssh -o StrictHostKeyChecking=no ubuntu@${DEV_SERVER} 'docker image prune -f'

                        echo "âœ… ì´ì „ ë°°í¬ ì •ë¦¬ ì™„ë£Œ"
                    '''
                }
            }
        }
    }

    post {
        always {
            // ì‘ì—… ê³µê°„ ì •ë¦¬
            cleanWs()
        }
        success {
            echo 'âœ… íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µ!'
        }
        failure{
            // ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
            echo 'âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨'
            emailext (
                subject: "ì‹¤íŒ¨: íŒŒì´í”„ë¼ì¸ '${currentBuild.fullDisplayName}'",
                body: "íŒŒì´í”„ë¼ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹Œë“œ URL: ${env.BUILD_URL}",
                to: 'ghkdtnql@gmail.com'
            )
        }
    }
}